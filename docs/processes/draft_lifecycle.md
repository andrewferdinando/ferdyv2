# Draft Lifecycle — Ferdy

> **Updated:** 2025-01-XX — Clarified draft ↔ post_jobs relationship, channel handling, and draft generation triggers.

## TL;DR (for AI tools)

Drafts live in the `drafts` table and represent **work-in-progress social posts** for a brand.

They are created by:

- **Nightly generator** (`/api/drafts/generate-all`) — automatic draft creation on a rolling 30-day window
- **Manual generation** (`/api/drafts/generate`) — on-demand generation for a specific brand
- **Automatic trigger** — after subcategory + schedule_rule creation (via `/api/drafts/generate` API route, not DB trigger)
- **New Post flow** from the Schedule page — manual post creation

Key points:

- A Draft holds: copy, hashtags, selected assets, scheduled time, status, and metadata.
- **One draft = one scheduled post time** (one `scheduled_for` timestamp).
- **Channels are represented by `post_jobs`, not by `drafts.channel`**.
- The **canonical schedule** is `scheduled_for` (UTC), with `scheduled_for_nzt` as a convenience for NZ local.
- Drafts are tied to **Categories** via `subcategory_id`.
- Publishing is handled via **`post_jobs`**; a draft has a primary `post_job_id`, but there can be multiple jobs per draft (one per channel).
- `drafts.channel` is legacy/primary only and should not be relied on for publishing.
- There are **two cron systems**:
  - Vercel Cron → nightly automatic draft generation (`/api/drafts/generate-all`).
  - 3rd-party cron → calls `/api/publishing/run` on Vercel to publish due drafts.

---

## 1. Business Lifecycle

At a high level, each post flows through:

1. **Creation**
   - From automatic generator (nightly cron or manual trigger).
   - From New Post (manual schedule).

2. **Draft**
   - Fully editable: copy, images, hashtags, date/time, channels.
   - Copy is automatically generated by AI (non-optional).
   - Drafts appear automatically in the Drafts tab.

3. **Scheduled**
   - Has a future `scheduled_for` time.
   - User approves the post (`approved = true`).
   - **Approval is the ONLY user action required before scheduling.**

4. **Published**
   - Publishing engine has pushed to social channels via API.
   - All relevant `post_jobs` are `success`.
   - Draft status updated to published.

Users can:

- Edit copy, images, hashtags, date & time.
- Change channels.
- Delete drafts.
- Publish immediately (Publish Now).

---

## 2. How Drafts Are Created

### 2.1 Draft Generation (Current Model)

**The generator is the single source of truth for draft creation in Ferdy.**

#### Nightly Automatic Generation

A Vercel Cron job runs nightly (Pacific/Auckland time) and calls `/api/drafts/generate-all`:

- Fetches all active brands (`status = 'active'`).
- For each brand, calls the shared generator utility (`generateDraftsForBrand`).
- Generates drafts for the next **30 days** (rolling window).
- Automatically generates copy for all drafts (new and existing with placeholder copy).
- Sends email notifications to brand admins/editors when new drafts are created.

#### Automatic Trigger After Subcategory Creation

When a subcategory + schedule_rule is successfully saved (via the Category Creation wizard):

- The wizard calls `/api/drafts/generate` with `{ brandId }` immediately after save succeeds.
- This ensures drafts are created right away, without waiting for the nightly cron.
- The trigger happens via API route call (not via database trigger).
- Draft generation is idempotent, so calling it multiple times is safe.

#### Rolling 30-Day Window

- The generator looks ahead **30 days from now** (UTC).
- The window is recalculated on each run, ensuring continuous coverage.
- Safe to add categories anytime — the generator will pick them up on the next run.
- Generator is **idempotent** — won't create duplicate drafts (checks for existing drafts before creating).

#### Manual Generation

For a specific brand, you can call `/api/drafts/generate` with a `brandId`:

- Uses the same generator logic as the nightly cron.
- Generates drafts for the next 30 days.
- Useful for testing or immediate generation after category creation.

#### What Gets Created

For each framework target (from `rpc_framework_targets`):

1. **Draft creation:**
   - Checks if a draft already exists for (`brand_id + subcategory_id + scheduled_for + schedule_source='framework'`).
   - If not, creates a new draft with:
     - `schedule_source = 'framework'`
     - `publish_status = 'draft'`
     - `approved = false` (user must approve)
     - `asset_ids` (may be empty if no asset available — this is acceptable)
     - `copy` may be `null` or `"Post copy coming soon…"` until copy generation completes

2. **Post jobs creation:**
   - Creates one `post_jobs` row per channel from `schedule_rules.channels` (normalized).
   - Each `post_jobs` row has `schedule_rule_id` set (never null for framework-generated drafts).
   - Links the first job's ID to `drafts.post_job_id` (for backward compatibility).
   - Channels are normalized: `instagram` → `instagram_feed`, `linkedin` → `linkedin_profile`.

3. **Copy generation:**
   - Automatically triggered for all drafts needing copy (new and existing with placeholder).
   - Copy generation is **automatic and non-optional**.
   - There is **no "regenerate copy" concept** — copy is generated once per draft.

4. **Email notification:**
   - If new drafts were created, sends "Monthly Drafts Ready for Approval" email to brand admins/editors.

### 2.2 New Post from Schedule page

When a user clicks **New Post** on the Schedule page:

- Ferdy creates a Draft with:
  - `brand_id`
  - `channel(s)` via associated `post_jobs`
  - `copy` (either empty or AI-generated)
  - `asset_ids` (optional)
  - `scheduled_for` / `scheduled_for_nzt`
  - `schedule_source = 'manual'`
- It also creates `post_jobs` rows, similar to generator-created drafts.

---

## 3. `drafts` table schema & meaning

**Table:** `drafts`

| Column              | Type                    | Default         | Purpose |
|---------------------|-------------------------|-----------------|---------|
| `id`                | uuid                    | `gen_random_uuid()` | Primary key for the draft. |
| `brand_id`          | uuid                    |                 | Brand this draft belongs to. |
| `post_job_id`       | uuid                    | `NULL`          | Primary/first `post_jobs.id` associated with this draft (for convenience). |
| `channel`           | text                    | `NULL`          | Legacy/primary channel; **should not be relied on for publishing**. Channels are handled via `post_jobs` (one per channel). |
| `copy`              | text                    | `NULL`          | Main body text of the post. |
| `hashtags`          | text[]                  | `NULL`          | List of hashtags explicitly stored on the draft (may be merged with defaults at publishing). |
| `asset_ids`         | uuid[]                  | `NULL`          | Ordered list of asset IDs (images/videos) selected for this draft. |
| `tone`              | text                    | `NULL`          | Optional tone hint (e.g. friendly, formal). |
| `generated_by`      | text                    | `'ai'`          | Who generated the copy initially (`ai`, `user`, etc.). |
| `created_by`        | uuid                    | `NULL`          | User ID of the human who created or last manually created this draft (if applicable). |
| `created_at`        | timestamptz             | `now()`         | When the draft row was created (UTC). |
| `approved`          | boolean                 | `false`         | Whether this draft has been explicitly approved for publishing. |
| `created_at_nzt`    | timestamptz             | `NULL`          | Convenience timestamp for New Zealand local time at creation (if used). |
| `scheduled_for`     | timestamptz             | `NULL`          | Scheduled publish time (UTC). |
| `scheduled_for_nzt` | timestamptz             | `NULL`          | Scheduled publish time in NZ local time (for UI convenience). |
| `schedule_source`   | text                    | `NULL`          | Where the schedule came from, e.g. `'framework'` (generator) or `'manual'`. |
| `scheduled_by`      | uuid                    | `NULL`          | User who set the schedule (for audit). |
| `publish_status`    | text                    | `'draft'`       | Publishing pipeline state, typically: `draft` / `pending` / `published` / `failed` / `partially_published`. |
| `copy_status`       | text                    | `'idle'`        | Copy generation state, used by the AI pipeline (e.g. `idle`, `queued`, `running`, `done`, `failed`). |
| `copy_model`        | text                    | `NULL`          | Identifier of the AI model used (e.g. `gpt-4.1-mini`). |
| `copy_meta`         | jsonb                   | `NULL`          | Extra metadata from copy generation (tokens, prompts, variations, etc.). |
| `subcategory_id`    | uuid                    | `NULL`          | Link to the Category (subcategory) this draft belongs to. |
| `status`            | text                    | `'draft'`       | Overall business status; often mirrors `publish_status` (`draft`, `scheduled`, `published`, etc.). |
| `published_at`      | timestamptz             | `NULL`          | When the draft was successfully published (based on post_jobs). |

> Note: The app currently uses both `publish_status` and `status`. Treat `publish_status` as the detailed publishing state and `status` as the higher-level lifecycle label exposed in the UI.

---

## 4. Relationship to `post_jobs`

Drafts are **not** sent directly to social APIs. Instead, Ferdy uses a `post_jobs` table.

**Key relationship:**
- **One draft = one scheduled post time** (one `scheduled_for` timestamp).
- **One draft can have multiple `post_jobs`**, one per channel from `schedule_rules.channels`.
- `post_jobs` tracks:
  - Channel (normalized: `instagram_feed`, `instagram_story`, `facebook`, `linkedin_profile`, etc.)
  - `schedule_rule_id` (always set for framework-generated drafts, never null)
  - Scheduled time + timezone
  - Status (`pending`, `success`, `failed`)
  - Any provider-specific IDs and error messages.

Generator logic:

- For each framework target:
  - Explicitly fetches the active schedule rule using `brand_id + subcategory_id + is_active = true`.
  - Inserts a `draft` (one per scheduled time).
  - Creates one `post_jobs` record per channel from `schedule_rules.channels` (normalized).
  - Each `post_jobs` row has `schedule_rule_id` set (never null).
  - Stores the first job's ID in `drafts.post_job_id` (for backward compatibility).
  - `drafts.channel` is set to the first channel (legacy/primary only).

Publishing logic operates exclusively on `post_jobs` and updates drafts based on results.

---

## 5. Lifecycle Transitions (Technical)

### 5.1 Creation → Draft

When the generator runs (`generateDraftsForBrand`):

- Insert into `drafts`:

  - `brand_id`
  - `subcategory_id`
  - `scheduled_for` (UTC from `rpc_framework_targets`)
  - `scheduled_for_nzt` (brand/NZ-local convenience)
  - `schedule_source = 'framework'`
  - `publish_status = 'draft'` (always 'draft', never 'pending')
  - `status = 'draft'`
  - `approved = false` (user must approve)
  - `asset_ids` pre-populated via `rpc_pick_asset_for_rule` (if available, may be empty)
  - `copy` may be `null` or `"Post copy coming soon…"` until copy generation completes

- Insert into `post_jobs` for each channel in `schedule_rules.channels` (normalized), with:

  - `schedule_rule_id` (always set, never null)
  - `channel` (normalized: `instagram` → `instagram_feed`, `linkedin` → `linkedin_profile`)
  - `status = 'pending'`
  - `scheduled_at` and timezone
  - `draft_id` linked back to the draft.

- Copy generation is automatically triggered for all drafts needing copy (new and existing).

For New Post flow:

- A similar insert happens, but `schedule_source` is `'manual'` and more fields (copy, assets) can be user-entered directly.

---

### 5.2 Draft → Scheduled (user interaction)

When a user edits and is happy with a draft:

- They may:
  - Set or change `scheduled_for` / `scheduled_for_nzt`.
  - Mark `approved = true`.
  - Ensure `publish_status` and `status` represent that it's ready (often `scheduled` or `pending`).
  - Update hashtags, assets, copy, etc.

These updates are typically performed via API routes or Supabase client calls from the UI.

If the user adjusts time or channels:

- Associated `post_jobs` are updated to match the new schedule:
  - New jobs may be added.
  - Old jobs may be removed or updated.

---

### 5.3 Copy generation

Copy generation is **automatic and non-optional** for all drafts created by the generator.

The generator (`generateDraftsForBrand`) triggers copy generation **automatically**:

- It finds **drafts needing copy** (empty copy or placeholder) within the 30-day window.
- It loads:
  - `schedule_rules` for frequency & event metadata.
  - `subcategories` for name, url, description, copy length, type, and default hashtags.
  - `post_jobs` for the specific schedule_rule occurrence.
- It builds `DraftCopyInput[]` and calls `processBatchCopyGeneration(brandId, draftsInput)`.

This pipeline:

- Uses `copy_status` to track progress (e.g. `queued` → `running` → `done`).
- Writes:
  - `copy` (final generated text).
  - `copy_model` (LLM identifier).
  - `copy_meta` (token counts, angles, variation hints, etc.).
  - `generated_by = 'ai'`.

**Important:** There is **no "regenerate copy" concept** — copy is generated once per draft. If copy generation fails:

- `copy_status` is set to an error state (e.g. `failed`).
- Draft remains editable; user can still write or adjust copy manually.

---

### 5.4 Scheduled → Published

Publishing is handled by an API endpoint (e.g. `/api/publishing/run`) invoked by a **3rd-party cron** (cron-job.org or similar):

1. Cron hits `/api/publishing/run` on Vercel every few minutes.
2. The publishing engine:
   - Finds `post_jobs` with `status = 'pending'` whose `scheduled_at <= now()`.
   - For each job:
     - Loads the associated draft and brand social credentials.
     - Calls the appropriate provider API (Meta, LinkedIn, etc.).
     - On success:
       - Updates `post_jobs.status = 'success'`.
       - Stores remote IDs and any metadata.
     - On failure:
       - Updates `post_jobs.status = 'failed'`.
       - Stores error message.

3. After processing jobs for a draft:
   - If **all jobs** succeeded:
     - `drafts.publish_status = 'published'`
     - `drafts.status = 'published'`
     - `drafts.published_at = now()`
     - **Email notification sent** to all brand admins and editors (see `email-notifications.md`)
   - If **some jobs** failed:
     - `drafts.publish_status = 'partially_published'`
   - If **all jobs** failed:
     - `publish_status = 'failed'` but `status` may remain scheduled for manual retry.

4. Publish Now:
   - When a user clicks **Publish Now**, the same publishing logic is triggered immediately for that draft, regardless of `scheduled_for`.

---

### 5.5 Deletion

When a draft is deleted:

- The draft row is removed (or `status` set to something like `deleted` depending on implementation).
- Associated `post_jobs` are either:
  - Hard-deleted, or
  - Marked as `cancelled` / `deleted`.

Publishing logic should ignore deleted/cancelled jobs.

---

## 6. Interaction with other systems

- **Categories (subcategories):**
  - Drafts inherit meaning and metadata (URLs, descriptions, copy lengths, default hashtags, etc.) from `subcategories` via `subcategory_id`.
- **Schedule Rules:**
  - The schedule that produced the draft is tracked via `post_jobs.schedule_rule_id` (always set, never null).
  - Channels come from `schedule_rules.channels` (normalized text array).
  - The combination `schedule_rules + rpc_framework_targets + generator` defines when drafts are created.
- **Generator:**
  - The generator (`generateDraftsForBrand`) is the single source of truth for draft creation.
  - It runs nightly via Vercel Cron and can be triggered manually for a specific brand.

---

## 7. History / notes

- **2025-12-05** — Draft lifecycle documented from:
  - `drafts` table schema
  - Generator pipeline
  - Publishing engine design and 3rd-party cron usage
  - Copy generation pipeline

- **2025-12-12** — Updated with email notification integration:
  - Monthly Drafts Ready email sent after generator creates new drafts
  - Post Published email sent after successful publishing
  - See `email-notifications.md` for complete details

- **2025-12-XX** — Migrated from Push to Drafts model to automatic generator:
  - Removed manual "Push to Drafts" button and monthly automation
  - Replaced with nightly generator on rolling 30-day window
  - Generator is idempotent and automatic
  - Copy generation is automatic and non-optional

- **2025-01-XX** — Clarified draft ↔ post_jobs relationship and channel handling:
  - One draft = one scheduled post time
  - Channels are represented by post_jobs, not drafts.channel
  - post_jobs.schedule_rule_id is always set (never null)
  - Channel normalization: instagram → instagram_feed, linkedin → linkedin_profile
  - Draft generation automatically triggered after subcategory + schedule_rule creation (via API route, not DB trigger)
  - Publishing operates exclusively on post_jobs

## Known legacy behaviour

Some older drafts may only have `instagram_feed` post_jobs, even if the schedule rule specifies multiple channels. This occurred when:
- Channel normalization was not applied at save time.
- Schedule rule resolution failed silently.
- Draft generation defaulted to a single channel.

A backfill process exists to create missing `post_jobs` for legacy drafts. The current system ensures all channels from `schedule_rules.channels` result in corresponding `post_jobs` rows.

If you change:

- Draft statuses
- How publishing engine determines "due" drafts
- How copy generation tracks `copy_status`
- Generator behavior or window size

…you should update this document and any related process docs:

- `schedule_rules.md`
- `rpc_framework_targets.md`
- `copy_generation.md`

Mermaid:
flowchart LR
    A[Created] -->|automatic generation\nor New Post| DRAFT[drafts.status='draft']

    DRAFT -->|User edits copy/assets/date| DRAFT
    DRAFT -->|User approves| SCH[drafts.status='scheduled'\npublish_status='scheduled']

    SCH -->|Time not reached| SCH
    SCH -->|User clicks Publish Now| PUBNOW[publish immediately]
    SCH -->|scheduled_at reached\npost_jobs processed| PUBLISHFLOW

    subgraph Publishing Outcomes
        PUBLISHFLOW[Publishing Engine\nprocesses post_jobs]
        PUBLISHFLOW --> ALLOK[drafts.status='published'\npublish_status='published']
        PUBLISHFLOW --> PARTIAL[drafts.status='partially_published']
        PUBLISHFLOW --> FAIL[drafts.status='scheduled'\npublish_status='failed'/errors shown]
    end

    SCH -->|User deletes draft| DEL[deleted / archived]
