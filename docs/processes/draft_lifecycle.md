# Draft Lifecycle — Ferdy

## TL;DR (for AI tools)

Drafts live in the `drafts` table and represent **work-in-progress social posts** for a brand.

They are created by:

- `rpc_push_to_drafts_now` (manual Push to Drafts + monthly pg_cron automation)
- New Post flow from the Schedule page
- (Potentially other UI flows in future)

Key points:

- A Draft holds: copy, hashtags, selected assets, channel, scheduled time, status, and metadata.
- The **canonical schedule** is `scheduled_for` (UTC), with `scheduled_for_nzt` as a convenience for NZ local.
- Drafts are tied to **Categories** via `subcategory_id`.
- Publishing is handled via **`post_jobs`**; a draft has a primary `post_job_id`, but there can be multiple jobs per draft (one per channel).
- There are **two cron systems**:
  - Supabase `pg_cron` → monthly automated Push to Drafts.
  - 3rd-party cron → calls `/api/publishing/run` on Vercel to publish due drafts.

---

## 1. Business Lifecycle

At a high level, each post flows through:

1. **Creation**
   - From Push to Drafts (manual or monthly automation).
   - From New Post (manual schedule).

2. **Draft**
   - Fully editable: copy, images, hashtags, date/time, channels.
   - Copy may still be generated by AI.

3. **Scheduled**
   - Has a future `scheduled_for` time.
   - User is happy with the post (approved flag).

4. **Published**
   - Publishing engine has pushed to social channels via API.
   - All relevant `post_jobs` are `success`.
   - Draft status updated to published.

Users can:

- Edit copy, images, hashtags, date & time.
- Change channels.
- Delete drafts.
- Publish immediately (Publish Now).

---

## 2. How Drafts Are Created

### 2.1 Push to Drafts (manual & automated)

When a user presses **Push to Drafts**, or when the monthly automation runs on the 15th, Ferdy:

1. Calls `rpc_framework_targets(p_brand_id)` to generate a list of **future targets** based on schedule rules.
2. Uses `rpc_push_to_drafts_now(p_brand_id)` to:
   - Insert rows into `drafts` for each target that doesn't already have a framework draft.
   - Insert rows into `post_jobs` for each required channel.
   - Attach a primary `post_job_id` to each draft.

For automated runs:

- Supabase `pg_cron` has a job:

  - `jobname`: `framework_push_monthly`
  - `schedule`: `0 2 15 * *` (02:00 on the 15th of each month)
  - `command`: `SELECT public.run_framework_push_monthly();`

- That function internally calls the same Push-to-Drafts logic as the UI.
- **After drafts are created**, an email notification is sent to all brand admins and editors informing them that drafts are ready for approval (see `email-notifications.md`).

### 2.2 New Post from Schedule page

When a user clicks **New Post** on the Schedule page:

- Ferdy creates a Draft with:
  - `brand_id`
  - `channel(s)` via associated `post_jobs`
  - `copy` (either empty or AI-generated)
  - `asset_ids` (optional)
  - `scheduled_for` / `scheduled_for_nzt`
  - `schedule_source = 'manual'` (conceptually; exact string depends on implementation)
- It also creates `post_jobs` rows, just like Push to Drafts.

---

## 3. `drafts` table schema & meaning

**Table:** `drafts`

| Column              | Type                    | Default         | Purpose |
|---------------------|-------------------------|-----------------|---------|
| `id`                | uuid                    | `gen_random_uuid()` | Primary key for the draft. |
| `brand_id`          | uuid                    |                 | Brand this draft belongs to. |
| `post_job_id`       | uuid                    | `NULL`          | Primary/first `post_jobs.id` associated with this draft (for convenience). |
| `channel`           | text                    | `NULL`          | Legacy/primary channel; in current design, channels are mainly handled via `post_jobs`. |
| `copy`              | text                    | `NULL`          | Main body text of the post. |
| `hashtags`          | text[]                  | `NULL`          | List of hashtags explicitly stored on the draft (may be merged with defaults at publishing). |
| `asset_ids`         | uuid[]                  | `NULL`          | Ordered list of asset IDs (images/videos) selected for this draft. |
| `tone`              | text                    | `NULL`          | Optional tone hint (e.g. friendly, formal). |
| `generated_by`      | text                    | `'ai'`          | Who generated the copy initially (`ai`, `user`, etc.). |
| `created_by`        | uuid                    | `NULL`          | User ID of the human who created or last manually created this draft (if applicable). |
| `created_at`        | timestamptz             | `now()`         | When the draft row was created (UTC). |
| `approved`          | boolean                 | `false`         | Whether this draft has been explicitly approved for publishing. |
| `created_at_nzt`    | timestamptz             | `NULL`          | Convenience timestamp for New Zealand local time at creation (if used). |
| `scheduled_for`     | timestamptz             | `NULL`          | Scheduled publish time (UTC). |
| `scheduled_for_nzt` | timestamptz             | `NULL`          | Scheduled publish time in NZ local time (for UI convenience). |
| `schedule_source`   | text                    | `NULL`          | Where the schedule came from, e.g. `'framework'` (Push to Drafts) or `'manual'`. |
| `scheduled_by`      | uuid                    | `NULL`          | User who set the schedule (for audit). |
| `publish_status`    | text                    | `'draft'`       | Publishing pipeline state, typically: `draft` / `pending` / `published` / `failed` / `partially_published`. |
| `copy_status`       | text                    | `'idle'`        | Copy generation state, used by the AI pipeline (e.g. `idle`, `queued`, `running`, `done`, `failed`). |
| `copy_model`        | text                    | `NULL`          | Identifier of the AI model used (e.g. `gpt-4.1-mini`). |
| `copy_meta`         | jsonb                   | `NULL`          | Extra metadata from copy generation (tokens, prompts, variations, etc.). |
| `subcategory_id`    | uuid                    | `NULL`          | Link to the Category (subcategory) this draft belongs to. |
| `status`            | text                    | `'draft'`       | Overall business status; often mirrors `publish_status` (`draft`, `scheduled`, `published`, etc.). |
| `published_at`      | timestamptz             | `NULL`          | When the draft was successfully published (based on post_jobs). |

> Note: The app currently uses both `publish_status` and `status`. Treat `publish_status` as the detailed publishing state and `status` as the higher-level lifecycle label exposed in the UI.

---

## 4. Relationship to `post_jobs`

Drafts are **not** sent directly to social APIs. Instead, Ferdy uses a `post_jobs` table.

- One draft can have **multiple `post_jobs`**, one per channel.
- `post_jobs` tracks:
  - Channel (instagram_feed, instagram_story, facebook_page, linkedin_profile, etc.)
  - Scheduled time + timezone
  - Status (`pending`, `success`, `failed`)
  - Any provider-specific IDs and error messages.

Push to Drafts logic:

- For each framework target:
  - Inserts a `draft`.
  - Creates one `post_jobs` record per channel from the schedule rule.
  - Stores the first job's ID in `drafts.post_job_id` (for easy linking from UI).

Publishing logic then acts on `post_jobs` and updates drafts based on results.

---

## 5. Lifecycle Transitions (Technical)

### 5.1 Creation → Draft

When `rpc_push_to_drafts_now` runs:

- Insert into `drafts`:

  - `brand_id`
  - `subcategory_id`
  - `scheduled_for` (UTC from `rpc_framework_targets`)
  - `scheduled_for_nzt` (brand/NZ-local convenience)
  - `schedule_source = 'framework'`
  - `publish_status = 'pending'` or `'draft'` (depending on implementation)
  - `status = 'draft'`
  - `approved = false`
  - `asset_ids` pre-populated via `rpc_pick_asset_for_rule` (if available)
  - `copy` may be set to a placeholder (e.g. "Post copy coming soon…")

- Insert into `post_jobs` for each channel in the schedule rule, with:

  - `status = 'pending'`
  - `scheduled_at` and timezone
  - `draft_id` linked back to the draft.

For New Post flow:

- A similar insert happens, but `schedule_source` is likely `'manual'` and more fields (copy, assets) can be user-entered directly.

---

### 5.2 Draft → Scheduled (user interaction)

When a user edits and is happy with a draft:

- They may:
  - Set or change `scheduled_for` / `scheduled_for_nzt`.
  - Mark `approved = true`.
  - Ensure `publish_status` and `status` represent that it's ready (often `scheduled` or `pending`).
  - Update hashtags, assets, copy, etc.

These updates are typically performed via API routes or Supabase client calls from the UI.

If the user adjusts time or channels:

- Associated `post_jobs` are updated to match the new schedule:
  - New jobs may be added.
  - Old jobs may be removed or updated.

---

### 5.3 Copy generation

The `/api/drafts/push` handler triggers copy generation **immediately after** drafts are created (during Push to Drafts):

- It finds **drafts needing copy** (empty copy or placeholder).
- It loads:
  - `schedule_rules` for frequency & event metadata.
  - `subcategories` for name, url, description, copy length, and type.
  - `post_jobs` for the specific schedule_rule occurrence.
- It builds `DraftCopyInput[]` and calls `processBatchCopyGeneration(brandId, draftsInput)`.

This pipeline:

- Uses `copy_status` to track progress (e.g. `queued` → `running` → `done`).
- Writes:
  - `copy` (final generated text).
  - `copy_model` (LLM identifier).
  - `copy_meta` (token counts, angles, variation hints, etc.).
  - `generated_by = 'ai'`.

If copy generation fails:

- `copy_status` is set to an error state (e.g. `failed`).
- Draft remains editable; user can still write or adjust copy manually.

---

### 5.4 Scheduled → Published

Publishing is handled by an API endpoint (e.g. `/api/publishing/run`) invoked by a **3rd-party cron** (cron-job.org or similar):

1. Cron hits `/api/publishing/run` on Vercel every few minutes.
2. The publishing engine:
   - Finds `post_jobs` with `status = 'pending'` whose `scheduled_at <= now()`.
   - For each job:
     - Loads the associated draft and brand social credentials.
     - Calls the appropriate provider API (Meta, LinkedIn, etc.).
     - On success:
       - Updates `post_jobs.status = 'success'`.
       - Stores remote IDs and any metadata.
     - On failure:
       - Updates `post_jobs.status = 'failed'`.
       - Stores error message.

3. After processing jobs for a draft:
   - If **all jobs** succeeded:
     - `drafts.publish_status = 'published'`
     - `drafts.status = 'published'`
     - `drafts.published_at = now()`
     - **Email notification sent** to all brand admins and editors (see `email-notifications.md`)
   - If **some jobs** failed:
     - `drafts.publish_status = 'partially_published'`
   - If **all jobs** failed:
     - `publish_status = 'failed'` but `status` may remain scheduled for manual retry.

4. Publish Now:
   - When a user clicks **Publish Now**, the same publishing logic is triggered immediately for that draft, regardless of `scheduled_for`.

---

### 5.5 Deletion

When a draft is deleted:

- The draft row is removed (or `status` set to something like `deleted` depending on implementation).
- Associated `post_jobs` are either:
  - Hard-deleted, or
  - Marked as `cancelled` / `deleted`.

Publishing logic should ignore deleted/cancelled jobs.

---

## 6. Interaction with other systems

- **Categories (subcategories):**
  - Drafts inherit meaning and metadata (URLs, descriptions, copy lengths, etc.) from `subcategories` via `subcategory_id`.
- **Schedule Rules:**
  - The schedule that produced the draft is tracked via `post_jobs.schedule_rule_id`.
  - The combination `schedule_rules + rpc_framework_targets + rpc_push_to_drafts_now` defines when drafts are created.
- **Runs tracking:**
  - The `runs` table tracks each Push to Drafts run (manual or monthly) with:
    - `kind = 'push_to_drafts'`
    - `status` + timestamps
    - `target_month`

---

## 7. History / notes

- **2025-12-05** — Draft lifecycle documented from:
  - `drafts` table schema
  - Push to Drafts pipeline
  - pg_cron job for monthly automation
  - Publishing engine design and 3rd-party cron usage
  - Copy generation pipeline

- **2025-12-12** — Updated with email notification integration:
  - Monthly Drafts Ready email sent after Push to Drafts
  - Post Published email sent after successful publishing
  - See `email-notifications.md` for complete details

If you change:

- Draft statuses
- How publishing engine determines "due" drafts
- How copy generation tracks `copy_status`

…you should update this document and any related process docs:

- `push_to_drafts.md`
- `schedule_rules.md`
- `rpc_framework_targets.md`

Mermaid:
flowchart LR
    A[Created] -->|initial save\nfrom Push to Drafts or New Post| DRAFT[drafts.status='draft']

    DRAFT -->|User edits copy/assets/date| DRAFT
    DRAFT -->|User approves| SCH[drafts.status='scheduled'\npublish_status='scheduled']

    SCH -->|Time not reached| SCH
    SCH -->|User clicks Publish Now| PUBNOW[publish immediately]
    SCH -->|scheduled_at reached\npost_jobs processed| PUBLISHFLOW

    subgraph Publishing Outcomes
        PUBLISHFLOW[Publishing Engine\nprocesses post_jobs]
        PUBLISHFLOW --> ALLOK[drafts.status='published'\npublish_status='published']
        PUBLISHFLOW --> PARTIAL[drafts.status='partially_published']
        PUBLISHFLOW --> FAIL[drafts.status='scheduled'\npublish_status='failed'/errors shown]
    end

    SCH -->|User deletes draft| DEL[deleted / archived]

